generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ───────────────────────────────────────────
//  MEASUREMENT SESSION (Provider-agnostic)
// ───────────────────────────────────────────
//

model MeasurementSession {
  id         String     @id @default(cuid())
  userId     String
  orderId    String?

  // Provider info
  provider   String // "mock" | "manual" | "3dlook"
  externalId String?    @unique // Provider's session ID (if any)

  // Status
  status     String // "pending" | "completed" | "failed"

  // URLs
  qrCodeUrl  String? // For QR-Code display (if applicable)
  mobileUrl  String // Where QR leads to

  // Result
  measurements Json? // Standardized format

  // Metadata
  metadata   Json? // Provider-specific data

  // Timestamps
  createdAt   DateTime   @default(now())
  completedAt DateTime?
  expiresAt   DateTime // Auto-cleanup old sessions

  // Relations
  user      User       @relation(fields: [userId], references: [id])
  order     Order?     @relation(fields: [orderId], references: [id])
  cartItems CartItem[]

  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@index([expiresAt])
}

//
// ───────────────────────────────────────────
//  USER
// ───────────────────────────────────────────
//

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  role                String // "tailor" | "customer" | "admin"
  firstName           String?
  lastName            String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now()) @updatedAt
  orders              Order[]
  tailor              Tailor?
  measurementSessions MeasurementSession[]
  reviews             Review[]
  cart                Cart?

  @@index([role])
  @@index([createdAt])
}

//
// ───────────────────────────────────────────
//  TAILOR (Schneiderprofil)
// ───────────────────────────────────────────
//

model Tailor {
  id              String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id         String   @unique

  // Profile Info
  name            String
  businessName    String?  // Geschäftsname (falls anders als name)
  bio             String?

  // Location
  country         String?
  city            String?
  location        String?  // Vollständige Adresse (optional)

  // Skills & Experience
  specialties     String[] @default([]) // z.B. ["suits", "dresses", "alterations"]
  languages       String[] @default([]) // z.B. ["en", "tr", "de"]
  yearsExperience Int?     // Jahre Erfahrung

  // Contact
  phone           String?
  website         String?

  // Stats
  rating          Float?   // Durchschnittsbewertung
  totalOrders     Int      @default(0)

  // Status
  isVerified      Boolean  @default(false)
  isActive        Boolean  @default(true)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user     User      @relation(fields: [user_id], references: [id])
  products Product[]
  reviews  Review[]

  @@index([country])
  @@index([rating])
  @@index([isVerified])
  @@index([isActive])
  @@index([totalOrders])
  @@index([yearsExperience])
}

//
// ───────────────────────────────────────────
//  PRODUCT (Produkte des Schneiders)
// ───────────────────────────────────────────
//

model Product {
  id          String         @id @default(cuid())
  tailorId    String
  title       String
  price       Float
  description String?
  category    String?
  isActive    Boolean        @default(true) // Für Cart-Validierung
  createdAt   DateTime       @default(now())

  tailor     Tailor         @relation(fields: [tailorId], references: [id])
  orderItems OrderItem[]
  images     ProductImage[]
  reviews    Review[]
  cartItems  CartItem[]

  @@index([tailorId])
  @@index([category])
  @@index([createdAt])
  @@index([price])
  @@index([isActive])
}

//
// ───────────────────────────────────────────
//  PRODUCT IMAGES (für Supabase Storage)
// ───────────────────────────────────────────
//

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String // Supabase public URL oder signed URL
  position  Int     @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([position])
}

//
// ───────────────────────────────────────────
//  ORDER
// ───────────────────────────────────────────
//

model Order {
  id                  String               @id @default(cuid())
  userId              String

  // Order Status
  status              String               @default("pending") // "pending" | "paid" | "processing" | "shipped" | "completed" | "cancelled"

  // Payment Info
  stripeSessionId     String?              @unique // Stripe Checkout Session ID
  stripePaymentIntent String?              @unique // Stripe Payment Intent ID
  totalAmount         Float                // Gesamtbetrag in EUR
  platformFee         Float                // Platform-Gebühr (10%)
  tailorAmount        Float                // Betrag für Schneider (90%)
  currency            String               @default("eur")

  // Shipping Info
  shippingAddress     Json?                // {name, street, city, zip, country}
  shippingMethod      String?              // "standard" | "express"
  trackingNumber      String?

  // Measurements
  measurementSessionId String?
  measurements        Json?                // Kopie der Measurements zum Zeitpunkt der Bestellung

  // Timestamps
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  paidAt              DateTime?
  shippedAt           DateTime?
  completedAt         DateTime?

  // Relations
  user                User                 @relation(fields: [userId], references: [id])
  items               OrderItem[]
  measurementSessions MeasurementSession[]

  @@index([userId])
  @@index([status])
  @@index([stripeSessionId])
}

//
// ───────────────────────────────────────────
//  ORDER ITEMS (Produkte in einer Bestellung)
// ───────────────────────────────────────────
//

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String
  tailorId    String  // Denormalisiert für einfacheres Querying

  // Product Details (snapshot at order time)
  productTitle       String
  productDescription String?
  quantity           Int     @default(1)
  unitPrice          Float   // Preis pro Stück zum Zeitpunkt der Bestellung
  subtotal           Float   // quantity * unitPrice

  // Customization
  customNotes        String? // Spezielle Wünsche vom Kunden
  fabricChoice       String? // Gewählter Stoff

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([tailorId])
}

//
// ───────────────────────────────────────────
//  REVIEW (Bewertungen für Produkte)
// ───────────────────────────────────────────
//

model Review {
  id      String @id @default(cuid())
  rating  Int    // 1-5 stars
  comment String?

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  tailorId String
  tailor   Tailor @relation(fields: [tailorId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, userId]) // One review per user per product
  @@index([productId])
  @@index([tailorId])
  @@index([userId])
  @@index([rating])
}

//
// ───────────────────────────────────────────
//  CART (Warenkorb)
// ───────────────────────────────────────────
//

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

//
// ───────────────────────────────────────────
//  CART ITEM (Warenkorb-Einträge)
// ───────────────────────────────────────────
//

model CartItem {
  id                   String              @id @default(cuid())
  cartId               String
  productId            String
  tailorId             String              // Denormalisiert für einfacheres Querying
  measurementSessionId String?             // Optional: Link zur Measurement Session
  priceAtAdd           Float               // Preis zum Zeitpunkt des Hinzufügens
  quantity             Int                 @default(1)
  notes                String?             // Spezielle Wünsche/Notizen
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  cart               Cart                @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product            Product             @relation(fields: [productId], references: [id])
  measurementSession MeasurementSession? @relation(fields: [measurementSessionId], references: [id], onDelete: SetNull)

  @@unique([cartId, productId]) // User kann Produkt nur einmal im Cart haben
  @@index([cartId])
  @@index([productId])
  @@index([measurementSessionId])
}
