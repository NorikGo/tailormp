generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ───────────────────────────────────────────
//  MEASUREMENT SESSION (Provider-agnostic)
// ───────────────────────────────────────────
//

model MeasurementSession {
  id         String    @id @default(cuid())
  userId     String
  orderId    String?

  // Provider info
  provider   String // "mock" | "manual" | "3dlook"
  externalId String?   @unique // Provider's session ID (if any)

  // Status
  status     String // "pending" | "completed" | "failed"

  // URLs
  qrCodeUrl  String? // For QR-Code display (if applicable)
  mobileUrl  String // Where QR leads to

  // Result
  measurements Json? // Standardized format

  // Metadata
  metadata   Json? // Provider-specific data

  // Timestamps
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime // Auto-cleanup old sessions

  // Relations
  user  User   @relation(fields: [userId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])

  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@index([expiresAt])
}

//
// ───────────────────────────────────────────
//  USER
// ───────────────────────────────────────────
//

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  role                String // "tailor" | "customer"
  orders              Order[]
  tailor              Tailor?
  measurementSessions MeasurementSession[]
}

//
// ───────────────────────────────────────────
//  TAILOR (Schneiderprofil)
// ───────────────────────────────────────────
//

model Tailor {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id   String   @unique
  name      String
  bio       String?
  country   String? // Land des Schneiders
  languages String[] @default([]) // z.B. ["en", "tr", "de"]
  rating    Float? // Durchschnittsbewertung

  user     User      @relation(fields: [user_id], references: [id])
  products Product[]
}

//
// ───────────────────────────────────────────
//  PRODUCT (Produkte des Schneiders)
// ───────────────────────────────────────────
//

model Product {
  id          String         @id @default(cuid())
  tailorId    String
  title       String
  price       Float
  description String?
  category    String?
  createdAt   DateTime       @default(now())

  tailor     Tailor         @relation(fields: [tailorId], references: [id])
  orderItems OrderItem[]
  images     ProductImage[]
}

//
// ───────────────────────────────────────────
//  PRODUCT IMAGES (für Supabase Storage)
// ───────────────────────────────────────────
//

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String // Supabase public URL oder signed URL
  position  Int     @default(0)

  product Product @relation(fields: [productId], references: [id])
}

//
// ───────────────────────────────────────────
//  ORDER
// ───────────────────────────────────────────
//

model Order {
  id                  String               @id @default(cuid())
  createdAt           DateTime             @default(now())
  userId              String
  user                User                 @relation(fields: [userId], references: [id])
  items               OrderItem[]
  measurementSessions MeasurementSession[]
}

//
// ───────────────────────────────────────────
//  ORDER ITEMS (Produkte in einer Bestellung)
// ───────────────────────────────────────────
//

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int     @default(1)
  unitPrice Float // Preis pro Stück zum Zeitpunkt der Bestellung

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}
